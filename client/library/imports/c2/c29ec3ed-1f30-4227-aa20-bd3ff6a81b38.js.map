{"version":3,"sources":["..\\..\\..\\..\\..\\..\\assets\\script\\helper\\Joystick/assets\\script\\helper\\Joystick\\Joystick.js"],"names":["cc","Class","extends","Component","properties","player","default","type","Node","displayName","tooltip","dot","ring","joystickType","JoystickEnum","JoystickType","FIXED","directionType","DirectionType","ALL","_stickPos","_touchLocation","onLoad","_radius","width","_initTouchEvent","FOLLOW","node","opacity","onEnable","JoystickEvent","getInstance","on","JoystickEventType","CHANGE_JOYSTICK_TYPE","_onChangeJoystickType","onDisable","off","EventType","TOUCH_START","_touchStartEvent","TOUCH_MOVE","_touchMoveEvent","TOUCH_END","_touchEndEvent","TOUCH_CANCEL","event","emit","touchPos","convertToNodeSpaceAR","getLocation","getPosition","distance","sub","mag","setPosition","posX","x","posY","y","p","v2","normalize","speedType","SpeedType","NORMAL","FAST","moveDistance","STOP","update","dt"],"mappings":"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","file":"Joystick.js","sourceRoot":"..\\..\\..\\..\\..\\..\\assets\\script\\helper\\Joystick","sourcesContent":["import JoystickEnum from './JoystickEnum';\nimport JoystickEvent from './JoystickEvent';\ncc.Class({\n    extends: cc.Component,\n \n    properties: {\n        player: {\n            default: null,\n            type: cc.Node,\n            displayName: 'player',\n            tooltip: '玩家角色',\n        },\n        dot: {\n            default: null,\n            type: cc.Node,\n            displayName: 'Dot',\n            tooltip: '摇杆操纵点',\n        },\n        ring: {\n            default: null,\n            type: cc.Node,\n            displayName: 'Ring',\n            tooltip: '摇杆背景节点',\n        },\n \n        joystickType: {\n            default: JoystickEnum.JoystickType.FIXED,\n            type: JoystickEnum.JoystickType,\n            displayName: 'Touch Type',\n            tooltip: '触摸类型',\n        },\n \n        directionType: {\n            default: JoystickEnum.DirectionType.ALL,\n            type: JoystickEnum.DirectionType,\n            displayName: 'Direction Type',\n            tooltip: '方向类型',\n        },\n \n        _stickPos: {\n            default: null,\n            type: cc.Node,\n            tooltip: '摇杆所在位置',\n        },\n        _touchLocation: {\n            default: null,\n            type: cc.Node,\n            tooltip: '触摸位置',\n        },\n    },\n \n    onLoad() {\n        this._radius = this.ring.width / 2;\n        this._initTouchEvent();\n        // hide joystick when follow\n        if (this.joystickType === JoystickEnum.JoystickType.FOLLOW) {\n            this.node.opacity = 0;\n        }\n    },\n \n    onEnable() {\n        JoystickEvent.getInstance().on(JoystickEnum.JoystickEventType.CHANGE_JOYSTICK_TYPE, this._onChangeJoystickType, this);\n    },\n \n    onDisable() {\n        JoystickEvent.getInstance().off(JoystickEnum.JoystickEventType.CHANGE_JOYSTICK_TYPE, this._onChangeJoystickType, this);\n    },\n \n    _onChangeJoystickType(type) {\n        this.joystickType = type;\n        this.node.opacity = type === JoystickEnum.JoystickType.FIXED ? 255 : 0;\n    },\n \n    _initTouchEvent() {\n        // set the size of joystick node to control scale\n        this.node.on(cc.Node.EventType.TOUCH_START, this._touchStartEvent, this);\n        this.node.on(cc.Node.EventType.TOUCH_MOVE, this._touchMoveEvent, this);\n        this.node.on(cc.Node.EventType.TOUCH_END, this._touchEndEvent, this);\n        this.node.on(cc.Node.EventType.TOUCH_CANCEL, this._touchEndEvent, this);\n    },\n \n    _touchStartEvent(event) {\n        JoystickEvent.getInstance().emit(JoystickEnum.JoystickEventType.TOUCH_START, \"joystick touch start\", 10);\n        const touchPos = this.node.convertToNodeSpaceAR(event.getLocation());\n        // console.log(this.node.convertToNodeSpaceAR(event.getLocation()));\n        \n \n        if (this.joystickType === JoystickEnum.JoystickType.FIXED) {\n            this._stickPos = this.ring.getPosition();\n \n            // 触摸点与圆圈中心的距离\n            const distance = touchPos.sub(this.ring.getPosition()).mag();\n \n            // 手指在圆圈内触摸,控杆跟随触摸点\n            this._radius > distance && this.dot.setPosition(touchPos);\n \n        } else if (this.joystickType === JoystickEnum.JoystickType.FOLLOW) {\n \n            // 记录摇杆位置，给 touch move 使用\n            this._stickPos = touchPos;\n            this.node.opacity = 255;\n            this._touchLocation = event.getLocation();\n \n            // 更改摇杆的位置\n            this.ring.setPosition(touchPos);\n            this.dot.setPosition(touchPos);\n        }\n    },\n \n    _touchMoveEvent(event) {\n        // 如果 touch start 位置和 touch move 相同，禁止移动\n        if (this.joystickType === JoystickEnum.JoystickType.FOLLOW && this._touchLocation === event.getLocation()) {\n            return false;\n        }\n \n        // 以圆圈为锚点获取触摸坐标\n        const touchPos = this.ring.convertToNodeSpaceAR(event.getLocation());\n        const distance = touchPos.mag();\n \n        // 由于摇杆的 postion 是以父节点为锚点，所以定位要加上 touch start 时的位置\n        const posX = this._stickPos.x + touchPos.x;\n        const posY = this._stickPos.y + touchPos.y;\n \n        // 归一化\n        const p = cc.v2(posX, posY).sub(this.ring.getPosition()).normalize();\n \n        let speedType;\n \n        if (this._radius > distance) {\n            this.dot.setPosition(cc.v2(posX, posY));\n \n            speedType = JoystickEnum.SpeedType.NORMAL;\n        } else {\n            // 控杆永远保持在圈内，并在圈内跟随触摸更新角度\n            const x = this._stickPos.x + p.x * this._radius;\n            const y = this._stickPos.y + p.y * this._radius;\n            this.dot.setPosition(cc.v2(x, y));\n \n            speedType = JoystickEnum.SpeedType.FAST;\n        }\n \n        JoystickEvent.getInstance().emit(JoystickEnum.JoystickEventType.TOUCH_MOVE, event, {speedType: speedType, moveDistance: p});\n    },\n \n    _touchEndEvent(event) {\n        this.dot.setPosition(this.ring.getPosition());\n        if (this.joystickType === JoystickEnum.JoystickType.FOLLOW) {\n            this.node.opacity = 0;\n        }\n \n        JoystickEvent.getInstance().emit(JoystickEnum.JoystickEventType.TOUCH_END, event, {speedType: JoystickEnum.SpeedType.STOP});\n    },\n\n    update (dt) {\n    }\n \n});\n \n"]}